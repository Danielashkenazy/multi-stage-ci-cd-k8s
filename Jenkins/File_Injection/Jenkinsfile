def USE_K8S = false

pipeline {

    agent { label 'ec2-agent' }

    parameters {
        string(name: 'FILE_PATH', defaultValue: 'Jenkins/example.txt', description: 'Path to the file inside the repo')
        string(name: 'TARGET_PATH', defaultValue: '/app/config/app-config.yaml', description: 'Destination path inside the pod')
    }

    environment {
        KUBECONFIG = "/home/ubuntu/.kube/config"
        NAMESPACE  = "devops"
        LABEL      = "app=rickandmorty"
        CONTAINER  = "rickandmorty"
    }

    stages {

        // ===============================
        // Detect Kubernetes Dynamic Agent
        // ===============================
        stage('Detect Kubernetes Availability') {
            steps {
                script {
                    try {
                        timeout(time: 120, unit: 'SECONDS') {
                            node('tools-agent') {
                                sh "echo 'K8S agent available'"
                            }
                        }
                        USE_K8S = true
                    } catch (err) {
                        USE_K8S = false
                    }
                }
            }
        }

        // ===============================
        // Checkout
        // ===============================
        stage('Checkout Repository') {
            steps {
                checkout scm
            }
        }

        // ===============================
        // Validate file exists
        // ===============================
        stage('Validate file exists') {
            steps {
                script {
                    if (!fileExists(params.FILE_PATH)) {
                        error "File does not exist: ${params.FILE_PATH}"
                    }
                }
            }
        }

        // ===============================
        // Find Running Pod
        // ===============================
        stage('Find Running Pod') {
            steps {
                script {
                    env.POD = sh(
                        script: """
                        kubectl get pods -n ${NAMESPACE} -l ${LABEL} \
                        --field-selector=status.phase=Running \
                        -o jsonpath='{.items[0].metadata.name}'
                        """,
                        returnStdout: true
                    ).trim()

                    if (!env.POD) {
                        error "No running pod found"
                    }
                }
            }
        }

        // ===============================
        // Copy File to Pod
        // ===============================
        stage('Copy file to pod') {
            steps {
                script {
                    if (USE_K8S) {
                        node('tools-agent') {
                            container('tools') {
                                sh """
                                kubectl cp ${FILE_PATH} ${NAMESPACE}/${POD}:${TARGET_PATH} -c ${CONTAINER}
                                """
                            }
                        }
                    } else {
                        sh """
                        kubectl cp ${FILE_PATH} ${NAMESPACE}/${POD}:${TARGET_PATH} -c ${CONTAINER}
                        """
                    }
                }
            }
        }

        // ===============================
        // Verify inside pod
        // ===============================
        stage('Verify inside pod') {
            steps {
                sh """
                kubectl exec -n ${NAMESPACE} ${POD} -c ${CONTAINER} -- ls -l ${TARGET_PATH}
                """
            }
        }
    }
}
