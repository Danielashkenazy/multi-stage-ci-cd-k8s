def USE_K8S = false   // dynamic fallback flag

pipeline {

    // ×‘×¨×™×¨×ª ××—×“×œ â€“ EC2 Jenkins agent
    agent { label 'ec2-agent' }

    environment {
        IMAGE_NAME = "danielashkenazy1/cicd_k8s_python_app"
        KUBECONFIG = "/home/ubuntu/.kube/config"
    }

    stages {

        // ============================================================
        // ×©×œ×‘ 0 â€“ ×‘×“×™×§×ª ×–××™× ×•×ª Kubernetes Dynamic Agent
        // ============================================================
        stage('Detect Kubernetes Availability') {
            steps {
                script {
                    echo "ğŸ” Checking Kubernetes dynamic agent availability..."

                    try {
                        timeout(time: 180, unit: 'SECONDS') {
                            node('tools-agent') {
                                sh "echo 'K8S dynamic agent works'"
                            }
                        }

                        USE_K8S = true
                        echo "âœ… K8S Agent is available â†’ using tools-agent for supported stages."

                    } catch (err) {
                        USE_K8S = false
                        echo "âš ï¸ K8S Agent NOT available â†’ fallback to EC2 for all stages."
                    }
                }
            }
        }

        // ============================================================
        // ×©×œ×‘ 1 â€“ Checkout
        // ============================================================
        stage('Checkout') {
            steps { checkout scm }
        }

        // ============================================================
        // ×©×œ×‘ 2 â€“ Secrets Detection (TruffleHog)
        // ×ª××™×“ ×¢×œ EC2 â€“ ××™×Ÿ Docker ×‘×ª×•×š Pod
        // ============================================================
        stage('Secrets Detection (TruffleHog)') {
            steps {
                echo "ğŸ•µï¸ Running TruffleHog on EC2 (docker required)..."

                sh '''
                docker run --rm \
                    -v "$(pwd):/scan" \
                    trufflesecurity/trufflehog:latest \
                    filesystem /scan/Docker --fail --no-update \
                    --exclude-paths /scan/Jenkins/ci/trufflehog_exclude.txt || true
                '''
            }
        }

        // ============================================================
        // ×©×œ×‘ 3 â€“ Lint (flake8) â€“ EXCLUDE venv
        // ============================================================
        stage('Lint') {
            steps {
                script {
                    def lintCmd = '''
                        cd Docker
                        python3 -m venv .venv
                        . .venv/bin/activate
                        pip install -r requirments.txt -q
                        pip install flake8 -q
                        flake8 . --exclude .venv
                    '''

                    if (USE_K8S) {
                        
                        echo "ğŸ”§ Running Lint in Kubernetes Pod..."
                        node('tools-agent') { 
                            checkout scm
                            sh lintCmd }
                    } else {
                        echo "ğŸ”§ Running Lint on EC2..."
                        sh lintCmd
                    }
                }
            }
        }

        // ============================================================
        // ×©×œ×‘ 4 â€“ Security Scan (bandit) â€“ EXCLUDE venv
        // ============================================================
        stage('Security Scan') {
            steps {
                script {
                    def banditCmd = '''
                        cd Docker
                        . .venv/bin/activate
                        pip install bandit -q
                        bandit -r . -ll --skip B104,B113 \
                        --exclude .venv,venv,__pycache__,*/.venv/*,*/venv/*,*/__pycache__/*

                    '''

                    if (USE_K8S) {
                        echo "ğŸ” Running Bandit in Kubernetes Pod..."
                        node('tools-agent') { 
                            checkout scm
                            sh banditCmd 
                        }
                    } else {
                        echo "ğŸ” Running Bandit on EC2..."
                        sh banditCmd
                    }
                }
            }
        }

        // ============================================================
        // ×©×œ×‘ 5 â€“ Tests (pytest) â€“ EXCLUDE venv
        // ============================================================
        stage('Unit Tests') {
            steps {
                script {
                    def testCmd = '''
                        cd Docker
                        . .venv/bin/activate
                        pip install pytest pytest-cov -q
                        pytest --cov=. --cov-report=html --cov-report=xml \
                               --junitxml=junit.xml \
                               --ignore=.venv
                    '''

                    if (USE_K8S) {
                        echo "ğŸ§ª Running Tests in Kubernetes Pod..."
                        node('tools-agent') { 
                            checkout scm
                            sh testCmd 
                        }
                    } else {
                        echo "ğŸ§ª Running Tests on EC2..."
                        sh testCmd
                    }
                }

                junit 'Docker/junit.xml'

                publishHTML(target: [
                    reportDir: 'Docker/htmlcov',
                    reportFiles: 'index.html',
                    reportName: "Coverage Report"
                ])
            }
        }

        // ============================================================
        // ×©×œ×‘ 6 â€“ ××™×©×•×¨ ×“×™×¤×œ×•×™
        // ============================================================
        stage('Approve Deployment') {
            steps {
                script {
                    timeout(time: 10, unit: 'MINUTES') {
                        input message: "Deploy to Docker Hub & Kubernetes?"
                    }
                }
            }
        }

        // ============================================================
        // ×©×œ×‘ 7 â€“ Build & Push Docker Image (EC2 only)
        // ============================================================
        stage('Build & Push Docker Image') {
            steps {
                script {
                    def sha = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()

                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {

                        sh """
                        cd Docker
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker build -t ${IMAGE_NAME}:ci-${sha} .
                        docker push ${IMAGE_NAME}:ci-${sha}
                        """
                    }

                    env.IMAGE_TAG = "ci-${sha}"
                }
            }
        }

        // ============================================================
        // ×©×œ×‘ 8 â€“ ×™×¦×™×¨×ª ×”Ö¾Secret ×‘Ö¾K8S
        // ============================================================
        stage('Create Docker Pull Secret in K8s') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {

                    sh '''
                    kubectl delete secret regcred -n devops --ignore-not-found=true

                    kubectl create secret docker-registry regcred \
                        --docker-server=https://index.docker.io/v1/ \
                        --docker-username=$DOCKER_USER \
                        --docker-password=$DOCKER_PASS \
                        -n devops
                    '''
                }
            }
        }

        // ============================================================
        // ×©×œ×‘ 9 â€“ Helm Deploy (EC2 only)
        // ============================================================
        stage('Deploy to Kubernetes (Helm)') {
            steps {
                sh """
                helm upgrade --install python-app ./Helm \
                    --namespace devops \
                    --set image.tag=${IMAGE_TAG}
                """
            }
        }
    }
}
