pipeline {
    agent { label 'ec2-agent' }

    parameters {
        string(name: 'FILE_PATH', defaultValue: 'Jenkins/example.txt', description: 'Path to the file inside the repo')
        string(name: 'TARGET_PATH', defaultValue: '/app/config/app-config.yaml', description: 'Destination path inside the pod')
    }

    environment {
        KUBECONFIG = "/home/ubuntu/.kube/config"
        NAMESPACE  = "devops"
        LABEL      = "app=rickandmorty"
        CONTAINER  = "rickandmorty"
    }

    stages {

        stage('Checkout Repository') {
            steps {
                checkout scm
            }
        }

        stage('Validate file exists') {
            steps {
                script {
                    if (!fileExists(params.FILE_PATH)) {
                        error "❌ File does not exist in repo: ${params.FILE_PATH}"
                    }
                    echo "✔ File exists: ${params.FILE_PATH}"
                }
            }
        }

        stage('Find Running Pod') {
            steps {
                script {
                    env.POD = sh(
                        script: """
                        kubectl get pods -n ${NAMESPACE} -l ${LABEL} \
                        --field-selector=status.phase=Running \
                        -o jsonpath='{.items[0].metadata.name}'
                        """,
                        returnStdout: true
                    ).trim()

                    if (!env.POD) {
                        error "❌ No Running pods found with label: ${LABEL}"
                    }

                    echo "✔ Using Running Pod: ${env.POD}"
                }
            }
        }

        stage('Copy file to pod') {
            steps {
                sh """
                echo "Copying file to pod..."
                kubectl cp ${FILE_PATH} ${NAMESPACE}/${POD}:${TARGET_PATH} -c ${CONTAINER}
                """
            }
        }

        stage('Verify inside pod') {
            steps {
                sh """
                echo "Verifying file inside pod..."
                kubectl exec -n ${NAMESPACE} ${POD} -c ${CONTAINER} -- ls -l ${TARGET_PATH}
                """
            }
        }
    }
}
